# Lesson 6 — `lesson6_shower+bonus.c`

Унисекс-душ с ограниченной вместимостью `N` и **симметричным равноправием** полов:
- одновременно внутри — только один пол;
- максимум `N` человек одновременно;
- отсутствует голодание: очередь переключается «честно».

## Сборка
```bash
gcc -O2 -Wall -Wextra -std=c11 lesson6_shower+bonus.c -o shower
```

## Быстрый старт (что ОБЯЗАТЕЛЬНО сделать)
1) **Инициализировать ресурсы** (создаёт семафоры и shared memory):
```bash
./shower init 3         # число 3 — вместимость N
```
   Альтернатива, которая предварительно всё очищает:
```bash
./shower force-init 3
```
2) **Только после init/run** запускать клиентов:
```bash
./shower run men 8
./shower run women 8
./shower run men 8 women 8   # параллельно обоих полов
```
3) **Очистить ресурсы** по завершении:
```bash
./shower destroy
```

Если запустить `run*` до `init/force-init`, получите ошибку вида **`semget attach: No such file or directory`** — это нормально, ресурсов ещё нет.

## CLI
```
./shower init <N>        # создать ресурсы, N — вместимость
./shower force-init <N>  # удалить и создать заново
./shower run-men <K>     # запустить K мужчин
./shower run-women <K>   # запустить K женщин
./shower run men <K> [women <K>]   # совместный прогон
./shower run women <K> [men <K>]   # совместный прогон
./shower selftest <N> <M> <W> <ROUNDS>
./shower destroy         # удалить ресурсы
```
Переменная окружения:
```
MAX_STREAK=<int>         # лимит подряд вошедших одной стороны; по умолчанию 2*N
```

## Как это работает (кратко)
Используются **SysV семафоры** и общая память:
- `SEM_MUTEX` — мьютекс для атомарного изменения состояния;
- `SEM_CAP` — «ёмкость» (кто входит — P, кто выходит — V);
- `SEM_MQ`/`SEM_WQ` — очереди ожидания (мужчины/женщины).

Состояние хранит: кто внутри/ждёт, текущий пол, чья «очередь» при пустой душевой, streak’и (сколько подряд заходили мужчины/женщины с момента последнего пустого состояния).

### Принцип равноправия
- Пока внутри один пол и есть свободные места — этот же пол может входить.
- Если **streak** одного пола достиг `MAX_STREAK` и противоположный пол ждёт, то при освобождении душевой происходит **переключение** к ожидающим.
- При пустой душевой и ожидании с обеих сторон применяется поле **`turn`** (чья очередь), после входа — `turn` переключается на противоположную сторону.
- Симметричные правила для обоих полов, поэтому голодание исключено.

## Логи: что пишется и что означает
Каждое действие печатается в stderr. Пример:
```
[ENTER][pid=2032 MEN] in: M=1 W=0 | wait: M=0 W=0 | cur=MEN cap=2 turn=MEN streakM=1 streakW=0
```
Поля:
- **Тег**: `ENTER`, `WAIT`, `WAIT(recheck)`, `LEAVE`, `SWITCH`.
  - `ENTER` — поток вошёл.
  - `WAIT` — поток не может войти и встал в очередь.
  - `WAIT(recheck)` — «двойная проверка»: занял слот, но условия изменились — вернулся ждать.
  - `LEAVE` — поток вышел.
  - `SWITCH` — принудительное переключение стороны ожидания; печатает `reason`.
- **pid** — PID процесса-клиента.
- **MEN/WOMEN** — пол текущего процесса.
- **in: M=x W=y** — внутри сейчас x мужчин и y женщин.
- **wait: M=a W=b** — в очереди ожидания a мужчин и b женщин.
- **cur=…** — текущий «режим» душевой: `MEN`, `WOMEN` или `NONE` (пусто).
- **cap=k** — вычисляемая остаточная вместимость: `N - (M_in + W_in)`.
- **turn=…** — чья очередь получит приоритет на ПУСТОЙ душевой (когда и мужчины, и женщины ждут).
- **streakM / streakW** — сколько подряд входило с момента последней пустоты (нужно для fairness).
- Для `SWITCH` добавляется `woke=<K>` — сколько разблокировано из очереди, и `reason`:
  - `men_streak_reached` / `women_streak_reached` — достигнут лимит `MAX_STREAK`.
  - `only_men_wait` / `only_women_wait` — ждёт только одна сторона, будим её целиком.
  - `turn` — оба ждут, душевая пуста, решает `turn`.

## Примеры
```bash
./shower force-init 3
./shower run men 7 women 7
./shower destroy
```
```bash
export MAX_STREAK=2
./shower run men 12 women 12
unset MAX_STREAK
```

## Отладочные подсказки
- Ошибка `semget attach: No such file or directory` → выполните `init` или `force-init`.
- Зависшие ресурсы после падения — всегда лечатся `./shower destroy` или `./shower force-init <N>`.

### Про MAX_STREAK: это `2×N`, а не `2^N`

По умолчанию лимит серии — **`MAX_STREAK = 2×N`** (линейно от ёмкости), а не `2^N`.
Такое значение:
- гарантирует, что каждая сторона может **несколько раз заполнить душевую целиком** (до `2×N` входов подряд) перед переключением;
- ограничивает задержку ожидания **O(N)** и предотвращает голодание;
- не «размывает» справедливость: `2^N` быстро становится слишком большим и на практике **откладывает переключение** (например, при `N=3` `2^N=8`, при `N=5` — уже `32`).

**Примеры:**  
`N=2 → MAX_STREAK=4`, `N=3 → MAX_STREAK=6`, `N=5 → MAX_STREAK=10`.

**Переопределение:** при необходимости можно выставить другое значение через переменную окружения:
```bash
# сделать экспоненциальный предел, если очень нужно
export MAX_STREAK=$((1<<N))   # здесь N — ваша ёмкость
./shower run men 10 women 10
unset MAX_STREAK
```
В логах переключение по этому правилу помечается как
`reason=men_streak_reached` / `women_streak_reached`.